
{% extends "layout.html" %}
{% block content %}

  <table align="center">
    <tr>
      <td valign="center">Actions sur la commande</td>
    </tr>
    <tr>
      <td>
        <a href="/orders/update/{{ order.id }}/annulation" class="btn btn-outline-dark" >Annuler Commande </a>
        <a href="/orders/update/{{ order.id }}/created" class="btn btn-outline-dark" >Créée </a>
        <a href="/orders/update/{{ order.id }}/paid" class="btn btn-outline-dark">Payée</a>
        <a href="/orders/update/{{ order.id }}/delivered" class="btn btn-outline-dark">Livrée</a>
        <a href="/orders/update/{{ order.id }}/time" class="btn btn-outline-dark">Date livraison</a>
      </td>
    </tr>
  </table>

<br>
<br>
    <div class="card  " >
        <div class="card-header text-white bg-info">
                Commande client
        </div>
        <div class="card-body">
          <h5 class="card-title"> N° {{order.id}} - {{order.title}}</h5>
          <p class="card-text">Commande créée le : <b style="color:rgb(199, 94, 94);">{{ order.created_at.strftime('%A %d %B %Y a %Hh:%Mmn' ) }}</b> par <b style="color:rgb(199, 94, 94);">{{customer.firstname}} {{customer.lastname}}</b></p>
          <br>
          <p><b>Liste des articles triés par vendeur :</b></p>
          <ul class="list-group list-group-flush">
          {% set total = {'value': 0.00} %}
          {% set nb_products = {'value': 0} %}
          {% set vendor = {'value': ''} %}
          {% for product in order.selected_products %}
            {% if vendor.value != product.vendor.name %}
            <li class="list-group-item bg-light">
                    <b>{{product.vendor.name}}</b>
                    {% set vendor = {'value': product.vendor.name} %}
            </li>
            {% endif%}
            <li class="list-group-item">
                
              <span class="badge badge-primary">{{product.price}} €</span> 
              {{product.name}}  
                {% for product_order in bought_items %}
                    {% if product_order.product_id == product.id %}
                    <span class="badge badge-warning">x {{product_order.quantity}}</span> 
                    {% if total.update({"value": (product_order.quantity * product.price)|float + total.value|float }) %} 
                    {% endif %}
                    {% if nb_products.update({"value": (product_order.quantity + nb_products.value) }) %} 
                    {% endif %}
                    <span style="float: right"> {{ (product_order.quantity * product.price) }}€</span>
                    {% endif%}
                {% endfor %}
            </li>
          {% endfor %}
          <li class="list-group-item">
                <b><span style="float: right">Nb articles : {{nb_products.value}} - Prix Total : {{ "%.2f"|format(total.value|float) }}€</span></b>
          </li>
          <li class="list-group-item">
                <b><span style="float: right">Prix de la livraison : {{delivery_price}} €</span></b>
                <br>
                <p><b>Règles de calcul :</b> {{rules}} </p>
          </li>
        </ul>

        </div>

      </div>

      <br>
      <div class="card">
          <div class="card-header text-white bg-info">
                  Livraison
          </div>
          <div class="card-body">
            <h5 class="card-title">Date de livraison {{ order.delivery_dt.strftime('%A %d %B %Y a %Hh:%Mmn') }}</h5>
            <p class="card-text">Adresse  : {{ customer.address }} {{ customer.cp }} {{ customer.city }} </p>
  
          </div>
  
        </div>
        <br>
        <div class="card">
            <div class="card-header text-white bg-info" >
                    Commandes auprès des vendeurs
            </div>
            <div class="card-body">
              <h5 class="card-title"></h5>
              <p class="card-text"></p>
                <ul class="list-group list-group-flush">
                {% for vendorOrder in order.vendorOrders %}
                <li class="list-group-item">
                    <b>Commande n° {{vendorOrder.id}} </b>  <span class="badge badge-warning">{{vendorOrder.status}}</span>
                    <b>Vendeur n° {{vendorOrder.vendor.id}} </b> - {{vendorOrder.vendor.name}}</p>
                </li>    
                {% endfor %}
                </ul>
            </div>
    
          </div>
    
{% endblock %}
{% block right_menu %}
<div class="content-section">
    <h3>Menu des commandes</h3>
    <p class='text-muted'>Une commande client génère des commandes vendeur
        <ul class="list-group">
        <li class="list-group-item list-group-item-light">
                <a class="nav-link" href="/orders/new">Création de commande</a></li>
        <li class="list-group-item list-group-item-light">
                <a class="nav-link" href="/orders">Liste des commandes</a></li>
        <li class="list-group-item list-group-item-light">Calendars</li>
        <li class="list-group-item list-group-item-light">etc</li>
        </ul>
    </p>
</div>
{% endblock %}






